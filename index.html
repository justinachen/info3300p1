<html>
<head>
<title>P1: Justina Chen (jjc382) and Ayah Dweik</title>
<link href="https://fonts.googleapis.com/css?family=Alegreya|Alegreya+Sans" rel="stylesheet">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/default.min.css">
<script src="https://d3js.org/d3.v4.min.js"></script>
<!-- <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script> -->
<script src="http://d3js.org/topojson.v2.min.js"></script>
<script src="https://d3js.org/d3-array.v1.min.js"></script>
<script src="https://d3js.org/d3-geo.v1.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v1.min.js"></script>


<style>
body { font-family: 'Calibri', sans-serif; }
svg { border: solid #ccc 1px; }
path.state { stroke: black; stroke-width: .5; }
.axisGreen path { stroke: #32CD32; stroke-width: 3px;}
</style>

</head>
<body>

<div id = "p1">
<script>
var p1 = d3.select("#p1");

var svg = p1.append("svg")
.attr("width", 600)
.attr("height", 400);

// var gs48 = [[0.98879, 0], [0, 0], [-0.050909, 0], [0, 0], [0.075528, 0]];

// var projection = d3.geoModifiedStereographic(gs48, [95, -38])
//       .scale(1000)
//       .clipAngle(55)
//       .center([-96.5563, 38.8675]);


// var projection = d3.geoModifiedStereographicGs48();
var projection = d3.geoModifiedStereographicGs48()


var pathGenerator = d3.geoPath().projection(projection);

// parse csv, modified from Feb 8 lecture

function parseLine (line) {
	return { 
		Employer: line["Employer"],
		Lat: line["Lat"],
		Long: line["Long"],
		Sector: line ["Sector"]
	};
}

// define these vars outside of the callback function

var rawData, employersCount, nestedData, states;
var condensed = [];
var loc = [];



d3.csv("cornell_data.csv", parseLine, function (error, data) {
	console.log("entered d3");

	rawData = data;

	// count number of times employer repeated

	employersCount = d3.nest()
	  .key(function(d) { return d.Employer; })
	  .rollup(function(v) { return v.length; })
	  .entries(rawData);

	// group entries by employer
	
	nestedData = d3.nest()
	.key(function (d) { return d.Employer; })
	.entries(rawData);


	// take only first entry for each employer 
	for (var employer in nestedData){
		temp = [];
		var employerNestedData = nestedData[employer].values;

		temp = [employerNestedData[0].Employer, parseFloat(employerNestedData[0].Lat), parseFloat(employerNestedData[0].Long), employerNestedData[0].Sector];

		temp2 = [parseFloat(employerNestedData[0].Long), parseFloat(employerNestedData[0].Lat)]
		condensed.push(temp);
		loc.push(temp2);
	};


	d3.json("us.json", function (error, data) {
		rawData = data;
		
		states = topojson.feature(rawData, rawData.objects.states);

		showMap();
	});

});

function showMap() {
	// Create or modify paths for each country
	
	projection.fitExtent([[0,0], [svg.attr("width"), svg.attr("height")]], states);
	pathGenerator = d3.geoPath().projection(projection);

	var paths = svg.selectAll("path.state").data(states.features);
	paths.enter().append("path").attr("class", "state")
	.merge(paths)
	.attr("d", function(state){
		return pathGenerator(state);
	});

	var circles = svg.selectAll("circle").data(loc);
	circles.exit().remove()
	circles.enter().append("circle").attr("r", 3)
	.merge(circles)
	.attr("cx", function(d){ return projection(d)[0]; })
	.attr("cy", function(d){ return projection(d)[1]; })
	.attr("fill-opacity", 0.4)
	.attr("fill", "red");
};


	
</script>
</div>


</body>
</html>
