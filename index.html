<html>
<head>
<title>P1: Justina Chen (jjc382) and Ayah Dweik</title>
<link href="https://fonts.googleapis.com/css?family=Alegreya|Alegreya+Sans" rel="stylesheet">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/default.min.css">
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="http://d3js.org/topojson.v2.min.js"></script>
<script src="https://d3js.org/d3-array.v1.min.js"></script>
<script src="https://d3js.org/d3-geo.v1.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v1.min.js"></script>

<style>
body {
  width: 100%;
  text-align:center;
  font-family: 'Calibri', sans-serif;
}

.main {
  padding: 20px;
  margin: 0 auto;
  display: inline-block;
}
.states{
  margin: auto;
  display: inline-block;
}
.logo{
  margin-right: 25px;
}
.section{
  width: 100%;
  margin: auto;
}

svg { 
  border: solid #ccc 1px; 
}
.stateSvg{
  margin-left: 15px;
  margin-right: 15px;
}

path.state {
  fill: #D3D3D3; stroke: black; stroke-width: .5; 
}
path.nyc {
  fill: #D3D3D3; stroke: black; stroke-width: .3; 
}



.axisGreen path {
 stroke: #32CD32; stroke-width: 3px;
}

.graticule {
  fill: none;
  stroke: #777;
  stroke-width: .5px;
  stroke-opacity: .5;
}
</style>

</head>
<body>
<div>
  <h1>Cornell vs. Berkeley Computer Science</h1>
  <h3>Undergraduate Employment Report 2013-2015</h3>
  <div class = "main" id = "cornell">
    <h2><img class="logo" src="logos/cornell_logo.png" alt="Cornell Logo" height="100" width="100" align="middle"> Cornell</h2>
    <svg id = "svgcornell" width="575" height = "383">
      <g transform = "translate (450) scale (0.65)">
        <text x="50" y="30">Technology</text>
        <text x="50" y="60">Other</text>
        <text x="50" y="90">Financial Services</text>
        <text x="50" y="120">Consulting</text>
        <rect width="10" height="10" x="30" y="20" style="stroke:black; fill:red;"></rect>
        <rect width="10" height="10" x="30" y="50" style="stroke:black; fill:blue;"></rect>
        <rect width="10" height="10" x="30" y="80" style="stroke:black; fill:green;"></rect>
        <rect width="10" height="10" x="30" y="110" style="stroke:black; fill:yellow;"></rect>
      </g>
    </svg>
  </div>

  <div class = "main" id = "berkeley">
    <h2><img class="logo" src="logos/cal_logo.png" alt="Berkeley Logo" height="100" width="auto" align="middle"> Berkeley</h2>
  </div>

  <div class = "states" id = "cornellState"></div>
  <div class = "states" id = "berkeleyState"></div>
</div>

<script>
var cornell = d3.select("#cornell");
var berkeley = d3.select("#berkeley");
var cornellState = d3.select("#cornellState");
var berkeleyState = d3.select("#berkeleyState");

// Cornell Map SVGs

var svgcornell = d3.select("#svgcornell");

cornell.append("br");
cornell.append("br");

var svgcornellCa = cornell.append("svg")
.attr("width", 250)
.attr("height", 400)
.attr("class", "stateSvg"); 

var svgcornellNy = cornell.append("svg")
.attr("width", 250)
.attr("height", 400)
.attr("class", "stateSvg"); 

// Berkeley Map SVGs
var svgberkeley = berkeley.append("svg")
.attr("width", 575)
.attr("height", 383);

berkeley.append("br");
berkeley.append("br");

var svgberkeleyCa = berkeley.append("svg")
.attr("width", 250)
.attr("height", 400)
.attr("class", "stateSvg"); 

var svgberkeleyNy = berkeley.append("svg")
.attr("width", 250)
.attr("height", 400)
.attr("class", "stateSvg"); 

var projection = d3.geoAlbersUsa(); 

var graticule = d3.geoGraticule();

var pathGenerator = d3.geoPath().projection(projection);

// parse csv, modified from Feb 8 lecture

function parseLine (line) {
  return { 
    Employer: line["Employer"],
    Lat: line["Lat"],
    Long: line["Long"],
    Sector: line ["Sector"]
  };
}

// define these vars outside of the callback function
var states;
var cornellsector = [];
var cornellloc = [];
var berkeleysector = [];
var berkeleyloc = [];
var cornellnumStudents = [];
var berkeleynumStudents = [];

var cornellcoords=[-76.4735, 42.4534];
var berkeleycoords=[-122.2727, 37.8716];


 // ************************************************************************************************
 // ************************************     CORNELL     *******************************************
 // ************************************************************************************************

d3.csv("cornellDataFull.csv", parseLine, function (error, data) {
  console.log("entered d3");

  var cornellData = data;

  // count number of times employer repeated
  employersCount = d3.nest()
    .key(function(d) { return d.Employer; })
    .rollup(function(v) { return v.length; })
    .entries(cornellData);

  // group entries by employer
  nestedData = d3.nest()
  .key(function (d) { return d.Employer; })
  .entries(cornellData);

  // take only first entry for each employer 
  for (var employer in nestedData){
    var employerNestedData = nestedData[employer].values;
    var sec = [employerNestedData[0].Sector];
    cornellsector.push(sec);
    var latlong = [parseFloat(employerNestedData[0].Long), parseFloat(employerNestedData[0].Lat)]
    cornellloc.push(latlong);
  };

  // create array of number of students per employer
  for (var employer in employersCount){
    cornellnumStudents.push(employersCount[employer].value)
  }

 // ************************************************************************************************
 // ************************************     BERKELEY    *******************************************
 // ************************************************************************************************
    d3.csv("berkeleyDataFull.csv", parseLine, function (error, data) {
    console.log("entered d3");

    berkeleyData = data;

    // count number of times employer repeated
    employersCount = d3.nest()
      .key(function(d) { return d.Employer; })
      .rollup(function(v) { return v.length; })
      .entries(berkeleyData);

    // group entries by employer
    nestedData = d3.nest()
    .key(function (d) { return d.Employer; })
    .entries(berkeleyData);


    // take only first entry for each employer 
    for (var employer in nestedData){
      var employerNestedData = nestedData[employer].values;
      var sec = [employerNestedData[0].Sector];
        berkeleysector.push(sec);
      var latlong = [parseFloat(employerNestedData[0].Long), parseFloat(employerNestedData[0].Lat)]
        berkeleyloc.push(latlong);
    };

    // create array of number of students per employer
    for (var employer in employersCount){
      berkeleynumStudents.push(employersCount[employer].value)
    }

    d3.json("us.json", function (error, data) {
      rawData = data;    
      states = topojson.feature(rawData, rawData.objects.states);
      console.log(states);
      showMap(svgberkeley, berkeleysector, berkeleyloc, berkeleynumStudents, berkeleycoords, false);
      showMap(svgcornell, cornellsector, cornellloc, cornellnumStudents, cornellcoords, true);
      showCa(svgcornellCa);
      showCa(svgberkeleyCa);
    });

  });

});


var nyData;
var manhattan;

// ny.json downloaded from https://github.com/dwillis/nyc-maps 
d3.json("ny.json", function (error, data) {
  nyData = data;
  manhattan = nyData.features.filter(function(d) { return d.properties.BoroName == "Manhattan"; });  
  showNy(svgcornellNy);
  showNy(svgberkeleyNy);

});

function showNy(svg) {
  // Create or modify paths for each country
  
  projection.fitExtent([[0,0], [svg.attr("width"), svg.attr("height")]], nyData)
  pathGenerator = d3.geoPath().projection(projection)

  var paths = svg.selectAll("path.nyc").data(manhattan);

  paths.enter().append("path").attr("class", "nyc")
  .merge(paths)
  .attr("d", function(nyc){
    return pathGenerator(nyc);
  });

  svg.selectAll("path")
  .attr("transform", "translate(-120 -150) scale(2.5) ")
};

var caProjection = d3.geoMercator()
  .scale(5000)
  .center([-122.4194, 37.7749])
  .translate([100, 250]);

function showCa(svg) {
  var caPathGenerator = d3.geoPath().projection(caProjection);

  var paths = svg.selectAll("path.state").data(states.features);
  console.log(paths);

  paths.enter().append("path").attr("class", "state")
  .merge(paths)
  .attr("d", function(state){
    return caPathGenerator(state);
  });

  var logoheight = 30;
  var logowidth = 30;

 svg.append("image")
  .attr("href", "logos/cal_logo.png")
  .attr("x", caProjection(berkeleycoords)[0]-logowidth/2)
  .attr("y", caProjection(berkeleycoords)[1]-logoheight/2)
  .attr("height", logoheight)
  .attr("width", logowidth);

};

function showMap(svg, sector, loc, numStudents, coords, iscornell) {

  // projection.fitExtent([[0,0], , states);
  projection.fitExtent([[0, 125], [svg.attr("width"), svg.attr("height")]], states);

  pathGenerator = d3.geoPath().projection(projection);

  var paths = svg.selectAll("path.state").data(states.features);
  paths.enter().append("path").attr("class", "state")
  .merge(paths)
  .attr("d", function(state){
    return pathGenerator(state);
  });

  svg.append("path")
    .datum(graticule)
    .attr("class", "graticule")
    .attr("d", pathGenerator);

  if (iscornell) { var logo = "logos/cornell_logo.png";}
  else{ var logo = "logos/cal_logo.png"; };

  var logowidth = 20;
  var logoheight = 20;

  svg.append("image")
    .attr("href", logo)
    .attr("x", projection(coords)[0]-logowidth/2)
    .attr("y", projection(coords)[1]-logoheight/2)
    .attr("height", logoheight)
    .attr("width", logowidth);

  var bars = svg.selectAll("line").data(loc);
  bars.exit().remove()
  bars.enter().append("line")
  .style("stroke-width", "4")
  .style("stroke", function(d, i){ 
    if (sector[i] == "Technology"){
      return "red";
      }
    else if (sector[i] == "Other"){
      return "blue";
    }
    else if (sector[i] == "Financial Services"){
      return "green";
    }
    else if (sector[i] == "Consulting"){
      return "yellow";
    }
  })
  .style("stroke-opacity", "0.3")
  .merge(bars)
  .attr("x1", function(d){ 
    if (projection(d) != null){
    return projection(d)[0];  }
    })
  .attr("y1", function(d){    
    if (projection(d) != null){
    return projection(d)[1];  }
    })
  .attr("x2", function(d){ 
    if (projection(d) != null){
    return projection(d)[0];  }
    })
  .attr("y2", function(d, i){
    if (projection(d) != null){
    return projection(d)[1] - numStudents[i]*15; }
    })
};



// var caProjection = d3.geoMercator()
//   .scale(100000)
//   .center([-122.2927387, 37.631258])
//   .translate([width / 2, height / 2]);


</script>


</div>


</body>
</html>
